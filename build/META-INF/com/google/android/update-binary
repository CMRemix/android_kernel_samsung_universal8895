#!/sbin/sh

OUTFD=$2
ZIP=$3

ui_print() {
  echo -n -e "ui_print $1\n" > /proc/self/fd/$OUTFD
  echo -n -e "ui_print\n" > /proc/self/fd/$OUTFD
}

cd /tmp
rm -rf zion
mkdir zion
cd zion
unzip -o "$ZIP"

getprop ro.boot.bootloader >> BLmodel

ui_print " ";
ui_print " - mounting system partition"
mount /system
ui_print " - mounting data partition"
mount /data

ui_print " - Installing ZION959-Kernel"
if grep -q G950 BLmodel; then
	cat dreamlte.img > /dev/block/platform/11120000.ufs/by-name/BOOT
	ui_print " - Flashing G950X kernel"
else if grep -q G955 BLmodel; then
	cat dream2lte.img > /dev/block/platform/11120000.ufs/by-name/BOOT
	ui_print " - Flashing G955X kernel"
else
	ui_print " - Model not support, no kernel flashed"
fi;
fi;

ui_print " - removing critical mcRegistry"
rm -f /system/app/mcRegistry/ffffffffd0000000000000000000000a.tlbin
rm -rf /data/media/0/Spectrum
rm -rf /system/etc/ZION_LOGs
rm -rf /system/etc/init.d
rm -rf /data/data/com.moro.mtweaks*
mkdir /system/etc/ZION_LOGs
mkdir /system/etc/init.d

ui_print " - removing vendor files"
rm -f /system/vendor/firmware/fimc_is_lib.bin
rm -f /system/vendor/firmware/fimc_is_rta_2l2_3h1.bin
rm -f /system/vendor/firmware/fimc_is_rta_2l2_imx320.bin
rm -f /system/vendor/firmware/fimc_is_rta_imx333_3h1.bin
rm -f /system/vendor/firmware/fimc_is_rta_imx333_imx320.bin
rm -f /system/vendor/lib/libsecure_storage.so
rm -f /system/vendor/lib/libsecure_storage_jni.so
rm -f /system/vendor/lib64/libsecure_storage.so
rm -f /system/vendor/lib64/libsecure_storage_jni.so
rm -f /system/etc/wifi/.clminfo
rm -f /system/etc/wifi/bcmdhd_clm.blob
rm -f /system/etc/wifi/bcmdhd_mfg.bin_b0
rm -f /system/etc/wifi/bcmdhd_sta.bin_b0
rm -f /system/etc/wifi/nvram.txt_murata_r031_b0
rm -f /system/etc/wifi/nvram.txt_murata_r032_b0
rm -f /system/etc/wifi/nvram.txt_murata_r033_b0
rm -f /system/etc/wifi/nvram.txt_r02j_b0
rm -f /system/etc/wifi/p2p_supplicant_overlay.conf
rm -f /system/etc/wifi/wldu.conf
rm -f /system/etc/wifi/wpa_supplicant.conf
rm -f /system/etc/wifi/wpa_supplicant_overlay.conf

cd
cd /tmp/zion
ui_print " - Copy Driver To Device"
mv -f vendor/firmware/fimc_is_lib.bin /system/vendor/firmware/fimc_is_lib.bin
mv -f vendor/firmware/fimc_is_rta_2l2_3h1.bin /system/vendor/firmware/fimc_is_rta_2l2_3h1.bin
mv -f vendor/firmware/fimc_is_rta_2l2_imx320.bin /system/vendor/firmware/fimc_is_rta_2l2_imx320.bin
mv -f vendor/firmware/fimc_is_rta_imx333_3h1.bin /system/vendor/firmware/fimc_is_rta_imx333_3h1.bin
mv -f vendor/firmware/fimc_is_rta_imx333_imx320.bin /system/vendor/firmware/fimc_is_rta_imx333_imx320.bin
mv -f vendor/lib/libsecure_storage.so /system/vendor/lib/libsecure_storage.so
mv -f vendor/lib/libsecure_storage_jni.so /system/vendor/lib/libsecure_storage_jni.so
mv -f vendor/lib64/libsecure_storage.so /system/vendor/lib64/libsecure_storage.so
mv -f vendor/lib64/libsecure_storage_jni.so /system/vendor/lib64/libsecure_storage_jni.so
mv -f wifi/.clminfo /system/etc/wifi/.clminfo
mv -f wifi/bcmdhd_clm.blob /system/etc/wifi/bcmdhd_clm.blob
mv -f wifi/bcmdhd_mfg.bin_b0 /system/etc/wifi/bcmdhd_mfg.bin_b0
mv -f wifi/bcmdhd_sta.bin_b0 /system/etc/wifi/bcmdhd_sta.bin_b0
mv -f wifi/nvram.txt_murata_r031_b0 /system/etc/wifi/nvram.txt_murata_r031_b0
mv -f wifi/nvram.txt_murata_r032_b0 /system/etc/wifi/nvram.txt_murata_r032_b0
mv -f wifi/nvram.txt_murata_r033_b0 /system/etc/wifi/nvram.txt_murata_r033_b0
mv -f wifi/nvram.txt_r02j_b0 /system/etc/wifi/nvram.txt_r02j_b0
mv -f wifi/p2p_supplicant_overlay.conf /system/etc/wifi/p2p_supplicant_overlay.conf
mv -f wifi/wldu.conf /system/etc/wifi/wldu.conf
mv -f wifi/wpa_supplicant.conf /system/etc/wifi/wpa_supplicant.conf
mv -f wifi/wpa_supplicant_overlay.conf /system/etc/wifi/wpa_supplicant_overlay.conf

ui_print " - setting permissions"
chmod 0644 /system/vendor/firmware/fimc_is_lib.bin
chmod 0644 /system/vendor/firmware/fimc_is_rta_2l2_3h1.bin
chmod 0644 /system/vendor/firmware/fimc_is_rta_2l2_imx320.bin
chmod 0644 /system/vendor/firmware/fimc_is_rta_imx333_3h1.bin
chmod 0644 /system/vendor/firmware/fimc_is_rta_imx333_imx320.bin
chmod 0644 /system/vendor/lib/libsecure_storage.so
chmod 0644 /system/vendor/lib/libsecure_storage_jni.so
chmod 0644 /system/vendor/lib64/libsecure_storage.so
chmod 0644 /system/vendor/lib64/libsecure_storage_jni.so
chmod 0644 /system/etc/wifi/.clminfo
chmod 0644 /system/etc/wifi/bcmdhd_clm.blob
chmod 0644 /system/etc/wifi/bcmdhd_mfg.bin_b0
chmod 0644 /system/etc/wifi/bcmdhd_sta.bin_b0
chmod 0644 /system/etc/wifi/nvram.txt_murata_r031_b0
chmod 0644 /system/etc/wifi/nvram.txt_murata_r032_b0
chmod 0644 /system/etc/wifi/nvram.txt_murata_r033_b0
chmod 0644 /system/etc/wifi/nvram.txt_r02j_b0
chmod 0644 /system/etc/wifi/p2p_supplicant_overlay.conf
chmod 0644 /system/etc/wifi/wldu.conf
chmod 0644 /system/etc/wifi/wpa_supplicant.conf
chmod 0644 /system/etc/wifi/wpa_supplicant_overlay.conf
chmod 0755 /system/etc/init.d/*

ui_print " "
ui_print "ENJOY! ZION959's Kernel"
rm -rf /tmp/zion
sync
